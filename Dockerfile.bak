FROM codercom/code-server:latest

# Switch to root for installations
USER root

# Install prerequisites (including .NET dependencies)
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    nano \
    vim \
    unzip \
    libc6 \
    libgcc1 \
    libgssapi-krb5-2 \
    libicu-dev \
    libssl-dev \
    libstdc++6 \
    zlib1g \
    && rm -rf /var/lib/apt/lists/*

# Set .NET environment variables BEFORE installation
ENV DOTNET_ROOT=/usr/share/dotnet
ENV PATH="${PATH}:/usr/share/dotnet"

# Install .NET 8 SDK
RUN wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh && \
    chmod +x dotnet-install.sh && \
    ./dotnet-install.sh --channel 8.0 --install-dir /usr/share/dotnet && \
    rm dotnet-install.sh && \
    ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet

# Verify .NET installation
RUN dotnet --version

# Pre-cache MCP NuGet packages (so they don't download each time)
RUN mkdir -p /tmp/warmup && \
    cd /tmp/warmup && \
    dotnet new console && \
    # dotnet add package Microsoft.Extensions.AI.ModelContextProtocol && \
    dotnet add package ModelContextProtocol --prerelease && \
    dotnet add package Microsoft.Extensions.Hosting && \
    dotnet restore && \
    cd / && \
    rm -rf /tmp/warmup

# Install Node.js (required for Claude Code CLI)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

# Verify installations
RUN dotnet --version && \
    node --version && \
    npm --version && \
    claude --version




# Create directories and set permissions BEFORE switching to coder user
RUN mkdir -p /home/coder/.config && \
    mkdir -p /home/coder/.nuget && \
    mkdir -p /home/coder/workspace && \
    chown -R coder:coder /home/coder




# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# old
# Switch back to coder user
# USER coder
# new
# IMPORTANT: Stay as root, let entrypoint switch to coder
WORKDIR /home/coder/workspace


# Expose code-server port
EXPOSE 8080
# Expose mcp http
EXPOSE 8083


# Set entrypoint to fix permissions and switch user
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

CMD ["code-server", "--bind-addr", "0.0.0.0:8080", "--auth", "password", "/home/coder/workspace"]